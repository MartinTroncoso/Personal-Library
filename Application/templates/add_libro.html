{% extends "layouts/base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Agregar libro</title>
</head>
<body class="bg-light">
    <div class="container mt-5">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-4">Buscar libros desde Google Books</h2>
        <a href="{% url 'biblioteca' %}" class="btn btn-outline-secondary">‚Üê Volver</a>
      </div>

        <div class="input-group mb-3">
          <input type="text" id="searchInput" class="form-control" placeholder="Buscar libro por t√≠tulo...">
          <button type="button" class="btn btn-primary" id="btnBuscar">Buscar</button>
        </div>
      
        <div id="resultados" class="row gy-4"></div>
      </div>
      
      <script>
        function buscarLibros() {
          const query = document.getElementById('searchInput').value;
          const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&langRestrict=es&maxResults=10`;
      
          fetch(url)
            .then(res => res.json())
            .then(data => mostrarLibros(data.items))
            .catch(err => console.error(err));
        }
      
        function mostrarLibros(libros) {
          const container = document.getElementById('resultados');
          container.innerHTML = ''; // Limpiar resultados anteriores
          
          if (!libros || libros.length === 0) {
            container.innerHTML = '<p>No se encontraron libros.</p>';
            return;
          }
      
          libros.forEach(libro => {
            const info = libro.volumeInfo;
            const title = info.title || "T√≠tulo desconocido";
            const authors = info.authors ? info.authors.join(', ') : "Autor desconocido";
            const img = info.imageLinks?.thumbnail || 'https://via.placeholder.com/128x180?text=Sin+Portada';
      
            const card = document.createElement('div');
            card.className = 'col-md-4';
      
            card.innerHTML = `
              <div class="card h-100">
                <img src="${img}" class="card-img-top" alt="Portada">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title">${title}</h5>
                  <p class="card-text text-muted">${authors}</p>
                  <button class="btn btn-success mt-auto" onclick='agregarLibro(${JSON.stringify(libro)})'>Agregar</button>
                </div>
              </div>
            `;
      
            container.appendChild(card);
          });
        }
      
        function agregarLibro(libro) {
          const info = libro.volumeInfo;

          const datos = {
            titulo: info.title || 'T√≠tulo desconocido',
            autores: info.authors ? info.authors.join(', ') : 'Autor desconocido',
            portada: info.imageLinks?.thumbnail || '',
            descripcion: info.description || '',
            isbn: info.industryIdentifiers?.[0]?.identifier || '',
            fecha_publicacion: info.publishedDate || '',
            portada: info.imageLinks?.thumbnail || 'https://via.placeholder.com/128x180?text=Sin+Portada'
          };

          fetch('/add_libro', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCSRFToken(),  // si est√°s usando Django
            },
            body: JSON.stringify(datos)
          })
          .then(response => response.json())
          .then(data => {
            if (data.status == 'success') {
              switch (data.accion) {
                case 'nuevo':
                  Swal.fire({
                    icon: 'success',
                    title: 'Libro agregado üìö',
                    text: 'Tu libro fue guardado con √©xito.'
                  });
                  break;
                case 'existente_nuevo_usuario':
                  Swal.fire({
                    icon: 'success',
                    title: '‚úÖ Ya exist√≠a el libro, pero ahora est√° asociado a vos',
                    text: 'Tu libro fue guardado con √©xito.'
                  });
                  break;
                case 'repetido':
                  Swal.fire({
                    icon: 'info',
                    title: '‚ÑπÔ∏è Ya ten√©s este libro en tu colecci√≥n',
                    text: 'El libro ya estaba guardado en tu biblioteca.'
                  });
                  break;
              }
            }
            else {
              alert('‚ùå Error al agregar el libro');
            }
          })
          .catch(error => {
            console.error('Error al enviar datos:', error);
          });
        }

        document.getElementById("btnBuscar").addEventListener("click", buscarLibros);

        // Presionar Enter en el input
        document.getElementById("searchInput").addEventListener("keydown", function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            buscarLibros();
          }
        });
      </script>

      <script>
        function getCSRFToken() {
          const name = 'csrftoken';
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            let c = cookies[i].trim();
            if (c.startsWith(name + '=')) {
              return c.substring(name.length + 1);
            }
          }
          return '';
        }
      </script>

      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </div>
</body>
</html>
{% endblock %}